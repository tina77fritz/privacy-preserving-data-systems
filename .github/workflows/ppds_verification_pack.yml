name: PPDS Verification Pack

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - find stray lines commands
        shell: bash
        run: |
          set -euo pipefail
          echo "Workflows:"
          ls -la .github/workflows || true
          echo "Search for suspicious 'lines' usage in workflow files:"
          grep -RIn "^\s*lines\s*=" .github/workflows || true
          grep -RIn "^\s*lines\." .github/workflows || true
          grep -RIn "^\s*lines\b" .github/workflows || true


      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install (editable)
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: Unit tests (if any)
        run: |
          pytest -q || true

      # ---------- KEY FIX #1: auto-locate JSON configs ----------
      - name: Resolve minimal example configs (JSON)
        run: |
          set -e

          echo "Listing examples/ (for debug):"
          if [ -d "examples" ]; then
            find examples -maxdepth 4 -type f | sed 's/^/ - /'
          else
            echo "No examples/ folder found."
          fi

          POLICY=$(find examples -maxdepth 4 -type f \
            \( -iname "policy*min*.json" -o -iname "policy_min*.json" -o -iname "*policy*min*.json" \) \
            | head -n 1)

          FEATURES=$(find examples -maxdepth 4 -type f \
            \( -iname "features*min*.json" -o -iname "feature*min*.json" -o -iname "*features*min*.json" \) \
            | head -n 1)

          if [ -z "$POLICY" ] || [ -z "$FEATURES" ]; then
            echo "::error::Could not find minimal JSON configs for policy/features under examples/."
            echo "::error::Please ensure you have minimal JSON configs in examples/ (policy_min*.json, features_min*.json)."
            exit 1
          fi

          echo "POLICY_PATH=$POLICY" >> $GITHUB_ENV
          echo "FEATURES_PATH=$FEATURES" >> $GITHUB_ENV

          echo "Using POLICY_PATH=$POLICY"
          echo "Using FEATURES_PATH=$FEATURES"

      - name: E2E - validate -> plan -> emit-sql (+ audit summary)
        run: |
          set -e
          mkdir -p artifacts

          # Reproducibility anchors (no ppds --version needed)
          git rev-parse HEAD | tee artifacts/git_commit.txt
          python -c "import sys; print(sys.version.replace('\n',' '))" | tee artifacts/python_version.txt
          pip freeze | tee artifacts/pip_freeze.txt

          # 1) Validate (fail-closed if invalid)
          ppds validate \
            --policy "$POLICY_PATH" \
            --features "$FEATURES_PATH" \
            --format json \
            | tee artifacts/validate_result.json

          # 2) Plan (auditable plan.json)
          ppds plan \
            --policy "$POLICY_PATH" \
            --features "$FEATURES_PATH" \
            --out artifacts/plan.json

          # Extract fingerprint + soft checks
          python - <<'PY'
          import json, hashlib, os
          from datetime import datetime, timezone
          
          def sha256_file(path):
            h = hashlib.sha256()
            with open(path, "rb") as f:
              for b in iter(lambda: f.read(8192), b""):
                h.update(b)
            return h.hexdigest()
          
          plan_path = "artifacts/plan.json"
          plan = json.load(open(plan_path, "r", encoding="utf-8"))
          
          plan_sha = sha256_file(plan_path)
          
          # Native fingerprint may be null in current PPDS output
          native_fp = plan.get("fingerprint")
          fp_final = native_fp if (isinstance(native_fp, str) and native_fp.strip()) else f"sha256:{plan_sha}"
          
          # Always write a usable fingerprint anchor
          open("artifacts/plan_fingerprint.txt", "w", encoding="utf-8").write(fp_final + "\n")
          
          # Audit report (schema-flexible, no 'explain' command needed)
          audit = []
          audit.append("# PPDS Plan Audit Report (CI Replay)")
          audit.append("")
          audit.append(f"- Generated (UTC): {datetime.now(timezone.utc).isoformat()}")
          audit.append(f"- Plan SHA256: `{plan_sha}`")
          audit.append(f"- Fingerprint used: `{fp_final}`" + (" (native)" if (isinstance(native_fp, str) and native_fp.strip()) else " (derived)"))
          audit.append("")
          audit.append("## Top-level keys present")
          for k in sorted(plan.keys()):
            audit.append(f"- {k}")
          audit.append("")
          
          for section in ["decision", "reasons"]:
            if section in plan:
              audit.append(f"## {section}")
              audit.append("```json")
              audit.append(json.dumps(plan.get(section), indent=2, sort_keys=True))
              audit.append("```")
              audit.append("")
          
          open("artifacts/audit_report.md", "w", encoding="utf-8").write("\n".join(audit))
          
          # 1-page reviewer summary
          summary = []
          summary.append("# Verification Summary (CI Replay)")
          summary.append("")
          summary.append("## Fixed Inputs")
          summary.append(f"- policy: `{os.environ.get('POLICY_PATH','')}`")
          summary.append(f"- features: `{os.environ.get('FEATURES_PATH','')}`")
          summary.append("")
          summary.append("## Outputs")
          summary.append(f"- plan fingerprint: `{fp_final}`")
          summary.append(f"- plan.json sha256: `{plan_sha}`")
          summary.append("")
          summary.append("## Checks")
          summary.append("- Plan JSON valid: PASS")
          summary.append(f"- Fingerprint present: {'PASS (native)' if (isinstance(native_fp, str) and native_fp.strip()) else 'PASS (derived)'}")
          summary.append(f"- Structured decision present: {'PASS' if 'decision' in plan else 'WARN'}")
          summary.append(f"- Structured reasons present: {'PASS' if 'reasons' in plan else 'WARN'}")
          summary.append("")
          open("artifacts/verification_summary.md", "w", encoding="utf-8").write("\n".join(summary))
          PY



          # Verification summary 
          checks = {
            "plan_json_valid": True,
            "fingerprint_present": bool(fp),
            "decision_present": "decision" in plan,
            "reasons_present": "reasons" in plan,
            "generated_files": {
              "plan.json": os.path.exists(plan_path),
              "audit_report.md": os.path.exists(md_path),
            }
          }
          open("artifacts/verification_checks.json","w",encoding="utf-8").write(
            json.dumps(checks, indent=2, sort_keys=True) + "\n"
          )

          summary = []
          summary.append("# Verification Summary (CI Replay)")
          summary.append("")
          summary.append("## Fixed Inputs")
          summary.append(f"- policy: `{os.environ.get('POLICY_PATH','')}`")
          summary.append(f"- features: `{os.environ.get('FEATURES_PATH','')}`")
          summary.append("")
          summary.append("## Outputs")
          summary.append(f"- plan fingerprint: `{fp}`" if fp else "- plan fingerprint: (missing)")
          summary.append(f"- plan.json sha256: `{sha256_file(plan_path)}`")
          summary.append("")
          summary.append("## Checks (Pass/Fail)")
          summary.append(f"- Plan JSON valid: {'PASS' if checks['plan_json_valid'] else 'FAIL'}")
          summary.append(f"- Fingerprint present: {'PASS' if checks['fingerprint_present'] else 'FAIL'}")
          summary.append(f"- Structured decision present: {'PASS' if checks['decision_present'] else 'WARN'}")
          summary.append(f"- Structured reasons present: {'PASS' if checks['reasons_present'] else 'WARN'}")
          summary.append("")
          summary.append("## Interpretation (plain language)")
          summary.append("- This run reproduces the systemâ€™s end-to-end behavior from fixed inputs.")
          summary.append("- The plan artifact provides an auditable record; the fingerprint anchors reproducibility.")
          summary.append("")
          open("artifacts/verification_summary.md","w",encoding="utf-8").write("\n".join(summary))
          PY

          # 3) Emit SQL (integration output)
          ppds emit-sql \
            --plan artifacts/plan.json \
            --dialect spark \
            --out artifacts/query.sql

          # Record SQL SHA
          python - << 'PY'
          import hashlib
          p="artifacts/query.sql"
          h=hashlib.sha256(open(p,"rb").read()).hexdigest()
          open("artifacts/query_sql_sha256.txt","w",encoding="utf-8").write(h+"\n")
          print("query.sql sha256:", h)
          PY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ppds-verification-pack
          path: artifacts/
