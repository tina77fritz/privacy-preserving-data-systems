name: PPDS Verification Pack

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - find stray python fragments
        shell: bash
        run: |
          set -euo pipefail
          grep -RIn "^\s*checks\s*=" .github/workflows || true
          grep -RIn "^\s*summary\s*=" .github/workflows || true
          grep -RInE "^\s*open\(" .github/workflows || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install (editable)
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: Unit tests (if any)
        run: |
          pytest -q || true

      - name: Resolve minimal example configs (JSON)
        shell: bash
        run: |
          set -euo pipefail

          echo "Listing examples/ (for debug):"
          if [ -d "examples" ]; then
            find examples -maxdepth 4 -type f | sed 's/^/ - /'
          else
            echo "::error::No examples/ folder found."
            exit 1
          fi

          POLICY=$(find examples -maxdepth 4 -type f \
            \( -iname "policy*min*.json" -o -iname "policy_min*.json" -o -iname "*policy*min*.json" \) \
            | head -n 1)

          FEATURES=$(find examples -maxdepth 4 -type f \
            \( -iname "features*min*.json" -o -iname "feature*min*.json" -o -iname "*features*min*.json" \) \
            | head -n 1)

          if [ -z "$POLICY" ] || [ -z "$FEATURES" ]; then
            echo "::error::Could not find minimal JSON configs for policy/features under examples/."
            exit 1
          fi

          echo "POLICY_PATH=$POLICY" >> $GITHUB_ENV
          echo "FEATURES_PATH=$FEATURES" >> $GITHUB_ENV

      - name: E2E - validate -> plan -> emit-sql (+ audit summary)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts

          git rev-parse HEAD | tee artifacts/git_commit.txt
          python -c "import sys; print(sys.version.replace('\n',' '))" | tee artifacts/python_version.txt
          pip freeze | tee artifacts/pip_freeze.txt

          ppds validate \
            --policy "$POLICY_PATH" \
            --features "$FEATURES_PATH" \
            --format json \
            | tee artifacts/validate_result.json

          ppds plan \
            --policy "$POLICY_PATH" \
            --features "$FEATURES_PATH" \
            --out artifacts/plan.json

          ppds emit-sql \
            --plan artifacts/plan.json \
            --dialect spark \
            --out artifacts/query.sql

          python - <<'PY'
          import json, hashlib, os
          from datetime import datetime, timezone
          
          def sha256_file(path):
            h = hashlib.sha256()
            with open(path, "rb") as f:
              for b in iter(lambda: f.read(8192), b""):
                h.update(b)
            return h.hexdigest()
          
          plan_path = "artifacts/plan.json"
          sql_path  = "artifacts/query.sql"
          
          plan = json.load(open(plan_path, "r", encoding="utf-8"))
          plan_sha = sha256_file(plan_path)
          sql_sha  = sha256_file(sql_path)
          
          native_fp = plan.get("fingerprint")
          fp_final = native_fp if (isinstance(native_fp, str) and native_fp.strip()) else f"sha256:{plan_sha}"
          
          open("artifacts/plan_fingerprint.txt", "w", encoding="utf-8").write(fp_final + "\n")
          open("artifacts/query_sql_sha256.txt","w",encoding="utf-8").write(sql_sha + "\n")
          
          audit = []
          audit.append("# PPDS Plan Audit Report (CI Replay)")
          audit.append("")
          audit.append(f"- Generated (UTC): {datetime.now(timezone.utc).isoformat()}")
          audit.append(f"- Plan SHA256: `{plan_sha}`")
          audit.append(f"- SQL SHA256: `{sql_sha}`")
          audit.append(f"- Fingerprint used: `{fp_final}`" + (" (native)" if (isinstance(native_fp, str) and native_fp.strip()) else " (derived)"))
          audit.append("")
          audit.append("## Top-level keys present")
          for k in sorted(plan.keys()):
            audit.append(f"- {k}")
          audit.append("")
          
          for section in ["decision", "reasons"]:
            if section in plan:
              audit.append(f"## {section}")
              audit.append("```json")
              audit.append(json.dumps(plan.get(section), indent=2, sort_keys=True))
              audit.append("```")
              audit.append("")
          
          open("artifacts/audit_report.md", "w", encoding="utf-8").write("\n".join(audit))
          
          summary = []
          summary.append("# Verification Summary (CI Replay)")
          summary.append("")
          summary.append("## Fixed Inputs")
          summary.append(f"- policy: `{os.environ.get('POLICY_PATH','')}`")
          summary.append(f"- features: `{os.environ.get('FEATURES_PATH','')}`")
          summary.append("")
          summary.append("## Outputs")
          summary.append(f"- plan fingerprint used: `{fp_final}`")
          summary.append(f"- plan.json sha256: `{plan_sha}`")
          summary.append(f"- query.sql sha256: `{sql_sha}`")
          summary.append("")
          open("artifacts/verification_summary.md", "w", encoding="utf-8").write("\n".join(summary))
          PY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ppds-verification-pack
          path: artifacts/
